# 时间记录小程序 - 开发进度文档

> 最后更新时间：2025-11-01

---

## 📊 项目概述

**项目名称**：时间记录小程序
**项目类型**：微信小程序（原生开发 + 云开发）
**主要功能**：通过语音录音记录时间，自动转文字，查看日/周/月统计

---

## ✅ 已实现功能

### 1. 录音功能
- ✅ 长按录音（最长60秒）
- ✅ 录音文件上传到云存储
- ✅ 录音格式：pcm（16000采样率，单声道，无损）
- ✅ 录音回放功能

### 2. 语音识别功能 ⭐
- ✅ 集成**讯飞语音识别API**（WebSocket流式识别）
- ✅ 自动将录音转为文字
- ✅ 识别准确率高（国内最好的中文识别引擎）
- ✅ 识别失败时允许手动输入

### 3. 记录编辑功能
- ✅ 编辑识别后的文字内容
- ✅ 保存时间记录到云数据库
- ✅ 关联录音文件

### 4. 数据查看功能
- ✅ 首页显示最近3条记录
- ✅ 日视图：查看某天的所有记录
- ✅ 周视图：查看本周统计
- ✅ 月视图：查看本月统计（待完善）

### 5. 我的设置
- ✅ 个人信息展示
- ✅ 使用说明

---

## 🏗️ 技术架构

### 前端（小程序端）

| 技术栈 | 说明 |
|--------|------|
| **框架** | 微信小程序原生框架 |
| **录音API** | `wx.getRecorderManager()` |
| **音频播放** | `wx.createInnerAudioContext()` |
| **云开发** | 微信云开发（数据库、存储、云函数） |
| **UI风格** | 黑色主题，简洁设计 |

### 后端（云函数）

| 云函数名称 | 功能 | 依赖包 |
|-----------|------|--------|
| **speech-recognition** | 语音识别 | wx-server-sdk, axios, ws, crypto-js |

### 数据库结构

**集合名称**：`records`

```json
{
  "_id": "记录ID",
  "_openid": "用户openid（自动生成）",
  "content": "记录内容（文字）",
  "audioPath": "录音文件的fileID",
  "startTime": "开始时间（Date）",
  "endTime": "结束时间（Date，可为空）",
  "duration": "时长（分钟）",
  "createTime": "创建时间（Date）"
}
```

---

## 🎤 语音识别功能实现详情

### 技术选型历程

我们尝试了多个语音识别方案：

| 方案 | 结果 | 原因 |
|------|------|------|
| 微信同声传译插件 | ❌ 失败 | 用户找不到该插件 |
| 百度语音识别API | ❌ 识别率低 | 多种格式和采样率都失败，准确率很差 |
| **讯飞语音识别API** | ✅ 成功 | 识别准确率高，国内最好的中文识别 |

### 百度API遇到的问题

在尝试百度API时遇到以下问题：

1. **错误3311**："param rate invalid"
   - 尝试了pcm、wav、mp3格式
   - 尝试了8000、16000、48000等所有常见采样率
   - 都报同样的错误

2. **识别结果不准确**
   - 即使API调用成功，识别结果也完全错误
   - 说"今天上午十点开会"，识别成"我不知道"

### 讯飞API实现方案 ⭐

**最终采用讯飞语音听写（流式版）WebAPI**

#### 配置信息

```javascript
// 讯飞AI配置（已申请）
APPID: de1cdf25
APIKey: 61dd1d6f6e4cf139c4e523eda8a1b791
APISecret: ZTRlYWQxM2RkMjhkNTgwY2ZkYTdhMzE1

// 免费额度
每天500次识别
并发2路
```

#### 技术实现

1. **WebSocket连接**
   - 使用wss协议连接讯飞服务器
   - 地址：`wss://iat-api.xfyun.cn/v2/iat`

2. **鉴权机制**
   - 使用HMAC-SHA256签名算法
   - 生成authorization header
   - 在URL中传递鉴权参数

3. **音频发送**
   - 下载云存储中的录音文件
   - 转换为base64编码
   - 通过WebSocket一次性发送
   - 格式：`audio/L16;rate=16000`（pcm原始格式）

4. **结果接收**
   - 实时接收识别结果
   - 拼接多个片段
   - 识别结束后返回完整文本

#### 核心代码位置

- 云函数：`cloudfunctions/speech-recognition/index.js`
- 小程序调用：`miniprogram/pages/index/index.js` 的 `recognizeSpeech()` 方法

---

## 📁 项目文件结构

```
TimeRecord/
├── cloudfunctions/
│   └── speech-recognition/          # 语音识别云函数
│       ├── index.js                 # 主逻辑（讯飞API集成）
│       ├── package.json             # 依赖：ws, crypto-js, axios
│       └── config.json              # 云函数配置
├── miniprogram/
│   ├── pages/
│   │   ├── index/                   # 首页（录音）
│   │   │   ├── index.js
│   │   │   ├── index.wxml
│   │   │   ├── index.wxss
│   │   │   └── index.json
│   │   ├── record-edit/             # 记录编辑页
│   │   ├── daily/                   # 日视图
│   │   ├── weekly/                  # 周视图
│   │   ├── monthly/                 # 月视图
│   │   └── settings/                # 我的设置
│   ├── app.js                       # 小程序入口
│   ├── app.json                     # 小程序配置
│   └── app.wxss                     # 全局样式
└── 开发进度.md                      # 本文档
```

---

## 🔧 关键配置

### 1. 云函数权限配置

`cloudfunctions/speech-recognition/config.json`:

```json
{
  "permissions": {
    "openapi": [
      "cloudbase.getTempFileURL"
    ]
  },
  "timeout": 30
}
```

### 2. 小程序云开发配置

`miniprogram/app.json`:

```json
{
  "cloud": true,
  "lazyCodeLoading": "requiredComponents"
}
```

### 3. 录音参数配置

```javascript
recorderManager.start({
  duration: 60000,      // 最长60秒
  sampleRate: 16000,    // 采样率16000（讯飞要求）
  numberOfChannels: 1,  // 单声道
  format: 'pcm'         // pcm格式（无损原始音频）
});
```

---

## 🚀 部署流程

### 首次部署

1. **配置云开发环境**
   - 微信开发者工具 → 云开发 → 开通
   - 选择环境ID

2. **部署云函数**
   - 右键 `cloudfunctions/speech-recognition`
   - 选择"上传并部署：云端安装依赖"
   - 等待部署完成（约1-2分钟）

3. **初始化数据库**
   - 云开发控制台 → 数据库
   - 创建集合：`records`

4. **配置域名白名单**（重要！）
   - 登录微信公众平台
   - 开发 → 开发管理 → 开发设置 → 服务器域名
   - 添加request合法域名：
     - `https://iat-api.xfyun.cn`
   - 添加socket合法域名：
     - `wss://iat-api.xfyun.cn`

### 更新部署

1. 修改代码后重新上传云函数
2. 小程序重新编译即可

---

## 🐛 已解决的问题

### 问题1：百度API错误3311

**现象**：无论使用什么格式和采样率，都报"param rate invalid"错误

**尝试方案**：
- 使用pcm格式 + 16000采样率 → 失败
- 使用wav格式 + 多种采样率 → 失败
- 使用mp3格式 + pro_api → 失败

**最终解决**：放弃百度API，改用讯飞API

---

### 问题2：识别准确率低

**现象**：百度API能调用成功，但识别结果完全错误

**原因分析**：
1. 音频格式/质量问题
2. 百度免费API识别能力有限

**最终解决**：切换到讯飞API，准确率大幅提升

---

### 问题3：WebSocket连接失败

**现象**：云函数调用讯飞API时WebSocket连接失败

**原因**：缺少ws依赖包

**解决方案**：在package.json中添加ws依赖，使用"云端安装依赖"部署

---

## 📝 待优化功能

### 高优先级

- [ ] 月视图完善（目前功能较简单）
- [ ] 记录分类功能（工作、生活、学习等）
- [ ] 记录搜索功能
- [ ] 数据导出功能（Excel）

### 中优先级

- [ ] 支持多种方言识别（讯飞支持）
- [ ] 录音质量优化（降噪）
- [ ] 识别结果编辑时的智能提示
- [ ] 数据统计图表优化

### 低优先级

- [ ] 多用户数据同步
- [ ] 分享功能
- [ ] 主题切换（深色/浅色）

---

## 💡 开发经验总结

### 1. 语音识别选型建议

- **讯飞** > 百度 > 腾讯
- 讯飞的中文识别准确率最高
- 免费额度500次/天足够个人使用
- WebSocket流式识别比HTTP接口更稳定

### 2. 录音格式选择

- **pcm格式最可靠**：原始无损音频
- 避免使用压缩格式（mp3、aac）在识别场景
- 采样率固定16000最稳定

### 3. 云函数开发注意事项

- 必须使用"云端安装依赖"，本地依赖不会上传
- timeout设置要足够（WebSocket需要时间）
- 善用console.log调试，查看云函数日志

### 4. 小程序开发技巧

- 录音权限要动态申请（`wx.authorize`）
- 云存储文件要用临时链接访问
- 错误处理要完善，用户体验更好

---

## 📞 联系信息

- **讯飞开放平台**：https://www.xfyun.cn/
- **讯飞控制台**：https://console.xfyun.cn/
- **语音听写API文档**：https://www.xfyun.cn/doc/asr/voicedictation/API.html

---

## 🎯 下次开发继续点

当您下次打开项目时，可以从以下方面继续：

1. **优化识别准确率**
   - 测试不同环境下的识别效果
   - 调整录音参数（如增加frameSize）
   - 添加降噪功能

2. **完善月视图功能**
   - 增加日历视图
   - 统计图表优化
   - 导出功能

3. **添加记录分类**
   - 修改数据库结构添加category字段
   - UI添加分类选择
   - 统计页按分类筛选

4. **性能优化**
   - 列表分页加载
   - 图片懒加载
   - 缓存优化

---

**🎉 当前版本：v1.0 - 语音识别功能已完成并正常工作！**
